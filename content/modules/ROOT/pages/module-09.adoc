= ラボガイド: Workflow Job Template の作成
:notoc:
:toc-title: Table of Contents
:nosectnums:
:icons: font

_複数 playbook を条件分岐付きの workflow でつなぎ、全体を連携させるためのガイド。_

---

== ラボ概要

**workflow job template** は、複数のリソースをグラフィカルに連携する仕組みです。複数の job templates（playbooks）、project sync、さらには他の workflows も含められ、複雑な多段オートメーションを構築できます。

image::wf-templates-home-with-example-wf-template.png[Workflow Job Templates list view, opts="border"]

---

== ラボガイド: ハンズオンタスク

**Workflow Job Template** は、特定の順序で実行される連結済みオートメーションタスクの集合です。通常の Job Template は単一 playbook を扱いますが、Workflow Job Template は複数 playbook と判断処理を含む、より複雑なシナリオ向けです。

workflow では、次のようなノードタイプをオーケストレーションできます。

* Job templates
* 他の workflow job templates
* Project syncs
* Inventory source syncs

[WARNING]
====
**Job Template**、**Jinja template**、**Workflow Job Template** を混同しないでください。これらは別々の概念です。
====

[IMPORTANT]
====
automation controller へのログイン認証情報:

* *Username:* `admin`
* *Password:* `ansible123!`
====

=== Task 1: Workflow Template を作成する

最初に、job templates を含めるメイン workflow を作成します。

. **Templates ページへ移動する。**
+
左側ナビゲーションメニューで **Automation Execution** → **Templates** に移動します。

. **新しい workflow job template を作成する。**
+
青色の **Create template** ボタンを **クリック** し、**Create workflow job template** を選択します。

. **workflow の詳細を入力する。**
+
フォームに以下を入力します。
+
* **Name:** `Your first workflow`
* **Description:** `Create a Workflow from previous Job Templates`
* **Organization:** `Default`
* **Inventory:** `Lab-Inventory`

. **workflow を保存する。**
+
他の項目はそのままにして、青色の **Create workflow job template** ボタンを **クリック** します。

=== Task 2: Workflow Visualizer で最初のステップを追加する

保存後、Workflow Visualizer に移動し、workflow をグラフィカルに構築します。

. **最初のステップを追加する。**
+
最初のノードを追加するため、**Start** ボタンを **クリック** します。

. **最初のノードを設定する。**
+
表示された *Add step* サイドパネルで、以下のように設定します。
+
* **Node Type:** `Job Template` (default)
* **Job Template:** `Install Apache`
* **Convergence:** `Any`
* **Node alias:** `apache101`（Visualizer 上で識別するためのラベル）

. **ノードを保存する。**
+
**Next** を **クリック** し、内容確認後に **Finish** を **クリック** します。

=== Task 3: 条件付きステップを追加する

次に、最初のステップが成功した場合のみ実行される 2 つ目のステップを追加します。

. **新しい連結ステップを追加する。**
+
`apache101` ノードに **マウスオーバー** し、**+** アイコンを **クリック** して **Add node** を選択します。

. **2 つ目のノードを設定する。**
+
サイドパネルで以下を設定します。
+
* **Node Type:** `Job Template` (default)
* **Job Template:** `Extended services`
* **Run:** `On Success`
* **Convergence:** `Any`
* **Node alias:** `extended201`

. **ノードを保存する。**
+
**Next** を **クリック** し、内容確認後に **Finish** を **クリック** します。

=== Task 4: 並列ステップを追加する

次に、最初のステップの後に 2 つ目と並列で実行される 3 つ目のステップを追加します。

. **最初のノードから別の連結ステップを追加する。**
+
再度 `apache101` ノードに **マウスオーバー** し、**+** アイコンを **クリック** して **Add node** を選択します。

. **3 つ目のノードを設定する。**
+
* **Node Type:** `Job Template` (default)
* **Job Template:** `Set motd`
* **Run:** `On Success`
* **Convergence:** `Any`
* **Node alias:** `motd201`

. **ノードを保存する。**
+
**Next** を **クリック** し、内容確認後に **Finish** を **クリック** します。

. **workflow 全体を保存する。**
+
最後に、Visualizer 右上の青色 **Save** ボタンを **クリック** します。この手順を忘れると変更が失われます。

=== Task 5: Workflow を起動する

これで多段 workflow を実行する準備ができました。

. **Visualizer から workflow を起動する。**
+
Workflow Visualizer 画面のまま、右上の **Launch** ボタンを **クリック** します。

. **実行を確認する。**
+
workflow 実行のリアルタイムビューに移動します。最初に `apache101` ジョブが実行され、成功後に `extended201` と `motd201` が並列実行されます。各ノードの緑のチェックマーク（✅）は成功を示します。

. **（別方法）Templates 一覧から起動する。**
+
**Templates** ページに戻り、`Your first workflow` の横にある **Launch** アイコン（🚀）をクリックして起動することもできます。

---

== 次のステップ

次のチャレンジに進むには、下の `Check` ボタンを押してください。

== トラブルシューティング

問題が発生した場合や不具合を見つけた場合は、link:https://github.com/ansible/workshops/issues/new?labels=controller-101&title=Issue+with+Intro+to+Controller+slug+ID:+controller-101-inventory+AAP25&assignees=leogallego[GitHub で issue を作成してください]。
